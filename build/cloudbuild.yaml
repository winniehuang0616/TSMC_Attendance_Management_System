substitutions:
  _TAG: "deploy-v$(date +%Y%m%d-%H%M%S)"

steps:
  # 登入 GKE
  - name: 'gcr.io/cloud-builders/gcloud'
    entrypoint: bash
    args:
      - -c
      - |
        gcloud container clusters get-credentials tsmc \
          --region=asia-east1 \
          --project=$PROJECT_ID

  # Build & push backend image
  - name: 'gcr.io/cloud-builders/docker'
    dir: 'backend'
    args: ['build', '-t', 'gcr.io/$PROJECT_ID/tsmc-backend:${_TAG}', '.']
  - name: 'gcr.io/cloud-builders/docker'
    args: ['push', 'gcr.io/$PROJECT_ID/tsmc-backend:${_TAG}']

  # Build & push frontend image
  - name: 'gcr.io/cloud-builders/docker'
    dir: 'frontend'
    args: ['build', '-t', 'gcr.io/$PROJECT_ID/tsmc-frontend:${_TAG}', '.']
  - name: 'gcr.io/cloud-builders/docker'
    args: ['push', 'gcr.io/$PROJECT_ID/tsmc-frontend:${_TAG}']

  # 替換 YAML 中的 image tag
  - name: 'gcr.io/cloud-builders/gcloud'
    entrypoint: bash
    args:
      - -c
      - |
        sed -i "s|gcr.io/.*/tsmc-backend:.*|gcr.io/$PROJECT_ID/tsmc-backend:${_TAG}|g" backend/k8s/backend/backend-deployment.yaml
        sed -i "s|gcr.io/.*/tsmc-frontend:.*|gcr.io/$PROJECT_ID/tsmc-frontend:${_TAG}|g" frontend/k8s/frontend/frontend-deployment.yaml

  # Apply K8s manifests
  - name: 'gcr.io/cloud-builders/kubectl'
    args: ['apply', '-f', 'backend/k8s']
    env:
      - CLOUDSDK_COMPUTE_REGION=asia-east1
      - CLOUDSDK_CONTAINER_CLUSTER=tsmc
  - name: 'gcr.io/cloud-builders/kubectl'
    args: ['apply', '-f', 'frontend/k8s']
    env:
      - CLOUDSDK_COMPUTE_REGION=asia-east1
      - CLOUDSDK_CONTAINER_CLUSTER=tsmc

  # Rollout restart (保險，確保 Pod 重啟)
  - name: 'gcr.io/cloud-builders/kubectl'
    args: ['rollout', 'restart', 'deployment/tsmc-backend']
    env:
      - CLOUDSDK_COMPUTE_REGION=asia-east1
      - CLOUDSDK_CONTAINER_CLUSTER=tsmc
  - name: 'gcr.io/cloud-builders/kubectl'
    args: ['rollout', 'restart', 'deployment/tsmc-frontend']
    env:
      - CLOUDSDK_COMPUTE_REGION=asia-east1
      - CLOUDSDK_CONTAINER_CLUSTER=tsmc

images:
  - gcr.io/$PROJECT_ID/tsmc-backend:${_TAG}
  - gcr.io/$PROJECT_ID/tsmc-frontend:${_TAG}

options:
  logging: CLOUD_LOGGING_ONLY
